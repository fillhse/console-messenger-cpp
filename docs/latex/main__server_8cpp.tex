\doxysection{server/main\+\_\+server.cpp File Reference}
\hypertarget{main__server_8cpp}{}\label{main__server_8cpp}\index{server/main\_server.cpp@{server/main\_server.cpp}}


Реализация сервера консольного мессенджера.  


{\ttfamily \#include $<$netinet/in.\+h$>$}\newline
{\ttfamily \#include $<$sys/select.\+h$>$}\newline
{\ttfamily \#include $<$sys/socket.\+h$>$}\newline
{\ttfamily \#include $<$unistd.\+h$>$}\newline
{\ttfamily \#include "{}telegram\+\_\+auth.\+h"{}}\newline
{\ttfamily \#include "{}history.\+h"{}}\newline
{\ttfamily \#include "{}socket\+\_\+utils.\+h"{}}\newline
{\ttfamily \#include $<$algorithm$>$}\newline
{\ttfamily \#include $<$cstring$>$}\newline
{\ttfamily \#include $<$ctime$>$}\newline
{\ttfamily \#include $<$iostream$>$}\newline
{\ttfamily \#include $<$map$>$}\newline
{\ttfamily \#include $<$sstream$>$}\newline
{\ttfamily \#include $<$unordered\+\_\+map$>$}\newline
{\ttfamily \#include $<$vector$>$}\newline
Include dependency graph for main\+\_\+server.\+cpp\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{main__server_8cpp__incl}
\end{center}
\end{figure}
\doxysubsubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{structClientInfo}{Client\+Info}}
\begin{DoxyCompactList}\small\item\em Информация о подключенном клиенте. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
std\+::string \mbox{\hyperlink{main__server_8cpp_a3f3b864aa1926634aeab0d037cefc11d}{get\+\_\+timestamp}} ()
\begin{DoxyCompactList}\small\item\em Получить текущую дату и время. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main__server_8cpp_adcd4551f3c0fc277e558c0dbe94c9084}{disconnect\+\_\+client}} (int fd, fd\+\_\+set \&master\+\_\+fds)
\begin{DoxyCompactList}\small\item\em Отключить клиента и очистить его данные. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main__server_8cpp_a2162e68ba4f5ca47d17798d623fbbcb8}{handle\+\_\+client\+\_\+command}} (int fd, const std\+::string \&msg, fd\+\_\+set \&master\+\_\+fds)
\begin{DoxyCompactList}\small\item\em Обработать команду клиента в режиме диалога. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main__server_8cpp_a9e4e4f430cdf91a029a3aaa1c1a543e6}{handle\+\_\+pending\+\_\+response}} (int fd, const std\+::string \&msg)
\begin{DoxyCompactList}\small\item\em Обработать ответ клиента на запрос соединения. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{main__server_8cpp_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}} ()
\begin{DoxyCompactList}\small\item\em Точка входа сервера. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
constexpr int \mbox{\hyperlink{main__server_8cpp_a765a3ccfceadb6670202a0753b6f61f1}{PORT}} = 9090
\begin{DoxyCompactList}\small\item\em Порт, на котором слушает сервер. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Реализация сервера консольного мессенджера. 

Сервер принимает подключения клиентов по TCP, обеспечивает авторизацию через Telegram-\/коды, обработку команд клиентов (/connect, /vote, /end, /help, /exit, /shutdown), передачу сообщений между участниками и хранение истории. 

Definition in file \mbox{\hyperlink{main__server_8cpp_source}{main\+\_\+server.\+cpp}}.



\doxysubsection{Function Documentation}
\Hypertarget{main__server_8cpp_adcd4551f3c0fc277e558c0dbe94c9084}\label{main__server_8cpp_adcd4551f3c0fc277e558c0dbe94c9084} 
\index{main\_server.cpp@{main\_server.cpp}!disconnect\_client@{disconnect\_client}}
\index{disconnect\_client@{disconnect\_client}!main\_server.cpp@{main\_server.cpp}}
\doxysubsubsection{\texorpdfstring{disconnect\_client()}{disconnect\_client()}}
{\footnotesize\ttfamily void disconnect\+\_\+client (\begin{DoxyParamCaption}\item[{int}]{fd,  }\item[{fd\+\_\+set \&}]{master\+\_\+fds }\end{DoxyParamCaption})}



Отключить клиента и очистить его данные. 

Завершает соединение, удаляет из наборов клиентов, уведомляет партнера беседы.


\begin{DoxyParams}{Parameters}
{\em fd} & Дескриптор сокета клиента для отключения. \\
\hline
{\em master\+\_\+fds} & Ссылка на набор файловых дескрипторов select(). \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{main__server_8cpp_source_l00085}{85}} of file \mbox{\hyperlink{main__server_8cpp_source}{main\+\_\+server.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordflow}{if}\ (clients.count(fd))\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ std::string\ \textcolor{keywordtype}{id}\ =\ clients[fd].id;}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ std::string\ connected\_to\ =\ clients[fd].connected\_to;}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nDisconnecting\ client:\ "{}}\ <<\ \textcolor{keywordtype}{id}\ <<\ \textcolor{stringliteral}{"{}\ (fd:\ "{}}\ <<\ fd\ <<\ \textcolor{stringliteral}{"{})\(\backslash\)n"{}};}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!connected\_to.empty()\ \&\&\ id\_to\_fd.count(connected\_to))\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ target\_fd\ =\ id\_to\_fd[connected\_to];}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ clients[target\_fd].connected\_to.clear();}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ clients[target\_fd].is\_speaking\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::string\ msg\ =\ \textcolor{stringliteral}{"{}\(\backslash\)nYour\ conversation\ partner\ has\ left\ the\ chat.\(\backslash\)n"{}};}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(target\_fd,\ msg.c\_str());}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ clients.erase(fd);}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ id\_to\_fd.erase(\textcolor{keywordtype}{id});}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ FD\_CLR(fd,\ \&master\_fds);}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ close(fd);}
\DoxyCodeLine{00103\ \ \ \ \ \}}
\DoxyCodeLine{00104\ \}}

\end{DoxyCode}
\Hypertarget{main__server_8cpp_a3f3b864aa1926634aeab0d037cefc11d}\label{main__server_8cpp_a3f3b864aa1926634aeab0d037cefc11d} 
\index{main\_server.cpp@{main\_server.cpp}!get\_timestamp@{get\_timestamp}}
\index{get\_timestamp@{get\_timestamp}!main\_server.cpp@{main\_server.cpp}}
\doxysubsubsection{\texorpdfstring{get\_timestamp()}{get\_timestamp()}}
{\footnotesize\ttfamily std\+::string get\+\_\+timestamp (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Получить текущую дату и время. 

Возвращает строку в формате "{}\+YYYY-\/\+MM-\/\+DD HH\+:\+MM"{}.

\begin{DoxyReturn}{Returns}
Форматированная метка времени. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{main__server_8cpp_source_l00069}{69}} of file \mbox{\hyperlink{main__server_8cpp_source}{main\+\_\+server.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00070\ \ \ \ \ time\_t\ now\ =\ time(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{keywordtype}{char}\ buf[20];}
\DoxyCodeLine{00072\ \ \ \ \ strftime(buf,\ \textcolor{keyword}{sizeof}(buf),\ \textcolor{stringliteral}{"{}\%Y-\/\%m-\/\%d\ \%H:\%M"{}},\ localtime(\&now));}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordflow}{return}\ std::string(buf);}
\DoxyCodeLine{00074\ \}}

\end{DoxyCode}
\Hypertarget{main__server_8cpp_a2162e68ba4f5ca47d17798d623fbbcb8}\label{main__server_8cpp_a2162e68ba4f5ca47d17798d623fbbcb8} 
\index{main\_server.cpp@{main\_server.cpp}!handle\_client\_command@{handle\_client\_command}}
\index{handle\_client\_command@{handle\_client\_command}!main\_server.cpp@{main\_server.cpp}}
\doxysubsubsection{\texorpdfstring{handle\_client\_command()}{handle\_client\_command()}}
{\footnotesize\ttfamily void handle\+\_\+client\+\_\+command (\begin{DoxyParamCaption}\item[{int}]{fd,  }\item[{const std\+::string \&}]{msg,  }\item[{fd\+\_\+set \&}]{master\+\_\+fds }\end{DoxyParamCaption})}



Обработать команду клиента в режиме диалога. 

Поддерживаемые команды\+:
\begin{DoxyItemize}
\item /connect $<$\+ID$>$
\item /vote
\item /end
\item /help
\item /exit
\end{DoxyItemize}


\begin{DoxyParams}{Parameters}
{\em fd} & Дескриптор сокета отправителя. \\
\hline
{\em msg} & Текст команды (без завершающего ~\newline
). \\
\hline
{\em master\+\_\+fds} & Набор дескрипторов select() для обновления. \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{main__server_8cpp_source_l00120}{120}} of file \mbox{\hyperlink{main__server_8cpp_source}{main\+\_\+server.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00121\ \ \ \ \ \textcolor{keywordflow}{if}\ (msg.rfind(\textcolor{stringliteral}{"{}/connect\ "{}},\ 0)\ ==\ 0)\ \{}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ std::string\ target\_id\ =\ msg.substr(9);}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (id\_to\_fd.count(target\_id))\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ target\_fd\ =\ id\_to\_fd[target\_id];}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!clients[target\_fd].pending\_request\_from.empty())\ \{}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}User\ is\ busy\ with\ another\ request.\(\backslash\)n"{}});}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!clients[target\_fd].connected\_to.empty())\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::string\ notice\ =\ \textcolor{stringliteral}{"{}\(\backslash\)nUser\ '"{}}\ +\ clients[fd].id\ +}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}'\ attempted\ to\ connect\ to\ you,\ but\ you\ are\ "{}}}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}already\ in\ a\ conversation.\(\backslash\)n"{}};}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(target\_fd,\ notice.c\_str());}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}User\ is\ already\ connected.\(\backslash\)n"{}});}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \ \ clients[target\_fd].pending\_request\_from\ =\ clients[fd].id;}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::string\ prompt\ =\ \textcolor{stringliteral}{"{}\(\backslash\)nUser\ '"{}}\ +\ clients[fd].id\ +\ \textcolor{stringliteral}{"{}'\ wants\ to\ connect.\ Accept?\ (yes/no)\(\backslash\)n"{}};}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(target\_fd,\ prompt.c\_str());}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}User\ not\ found.\(\backslash\)n"{}});}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00146\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (msg\ ==\ \textcolor{stringliteral}{"{}/vote"{}})\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (clients[fd].is\_speaking)\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ target\_id\ =\ clients[fd].connected\_to;}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!target\_id.empty()\ \&\&\ id\_to\_fd.count(target\_id))\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ target\_fd\ =\ id\_to\_fd[target\_id];}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ clients[fd].is\_speaking\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ clients[target\_fd].is\_speaking\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(fd,\ \textcolor{stringliteral}{"{}You\ passed\ the\ microphone.\(\backslash\)n"{}});}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(target\_fd,\ \textcolor{stringliteral}{"{}You\ are\ now\ speaking.\(\backslash\)n"{}});}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}No\ connected\ client\ to\ pass\ speaking\ right.\(\backslash\)n"{}});}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}You\ are\ not\ the\ current\ speaker.\(\backslash\)n"{}});}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00161\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (msg\ ==\ \textcolor{stringliteral}{"{}/end"{}})\ \{}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ std::string\ partner\_id\ =\ clients[fd].connected\_to;}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!partner\_id.empty()\ \&\&\ id\_to\_fd.count(partner\_id))\ \{}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ partner\_fd\ =\ id\_to\_fd[partner\_id];}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ clients[partner\_fd].connected\_to.clear();}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \ \ clients[partner\_fd].is\_speaking\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(partner\_fd,\ \textcolor{stringliteral}{"{}\(\backslash\)nYour\ conversation\ partner\ has\ ended\ the\ chat.\(\backslash\)n"{}});}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ clients[fd].connected\_to.clear();}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ clients[fd].is\_speaking\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}You\ have\ left\ the\ conversation.\(\backslash\)n"{}});}
\DoxyCodeLine{00172\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (msg\ ==\ \textcolor{stringliteral}{"{}/help"{}})\ \{}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::string\ help\ =}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Available\ commands:\(\backslash\)n"{}}}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}/connect\ <ID>\ -\/\ request\ chat\ with\ user\(\backslash\)n"{}}}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}/vote\ \ \ \ \ \ \ \ \ -\/\ pass\ speaker\ role\(\backslash\)n"{}}}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}/end\ \ \ \ \ \ \ \ \ \ -\/\ end\ current\ conversation\(\backslash\)n"{}}}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}/exit\ \ \ \ \ \ \ \ \ -\/\ exit\ the\ chat\ completely\(\backslash\)n"{}}}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}/help\ \ \ \ \ \ \ \ \ -\/\ show\ this\ message\(\backslash\)n"{}};}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ help.c\_str());}
\DoxyCodeLine{00181\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (msg\ ==\ \textcolor{stringliteral}{"{}/exit"{}})\ \{}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{main__server_8cpp_adcd4551f3c0fc277e558c0dbe94c9084}{disconnect\_client}}(fd,\ master\_fds);}
\DoxyCodeLine{00183\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}Only\ /connect\ <ID>,\ /vote,\ /end,\ /exit,\ /help\ are\ allowed.\(\backslash\)n"{}});}
\DoxyCodeLine{00185\ \ \ \ \ \}}
\DoxyCodeLine{00186\ \}}

\end{DoxyCode}
\Hypertarget{main__server_8cpp_a9e4e4f430cdf91a029a3aaa1c1a543e6}\label{main__server_8cpp_a9e4e4f430cdf91a029a3aaa1c1a543e6} 
\index{main\_server.cpp@{main\_server.cpp}!handle\_pending\_response@{handle\_pending\_response}}
\index{handle\_pending\_response@{handle\_pending\_response}!main\_server.cpp@{main\_server.cpp}}
\doxysubsubsection{\texorpdfstring{handle\_pending\_response()}{handle\_pending\_response()}}
{\footnotesize\ttfamily void handle\+\_\+pending\+\_\+response (\begin{DoxyParamCaption}\item[{int}]{fd,  }\item[{const std\+::string \&}]{msg }\end{DoxyParamCaption})}



Обработать ответ клиента на запрос соединения. 

Если клиент ранее отправил /connect и ожидает ответа, эта функция устанавливает связь и пересылает историю.


\begin{DoxyParams}{Parameters}
{\em fd} & Дескриптор сокета отвечающего клиента. \\
\hline
{\em msg} & Сообщение-\/ответ ("{}yes"{}/"{}no"{}). \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{main__server_8cpp_source_l00197}{197}} of file \mbox{\hyperlink{main__server_8cpp_source}{main\+\_\+server.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00198\ \ \ \ \ \mbox{\hyperlink{structClientInfo}{ClientInfo}}\&\ responder\ =\ clients[fd];}
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{keywordflow}{if}\ (responder.\mbox{\hyperlink{structClientInfo_a838fea06ffc413229e517e39e933020b}{pending\_request\_from}}.empty())}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \ \ \ \ std::string\ requester\_id\ =\ responder.\mbox{\hyperlink{structClientInfo_a838fea06ffc413229e517e39e933020b}{pending\_request\_from}};}
\DoxyCodeLine{00203\ \ \ \ \ responder.\mbox{\hyperlink{structClientInfo_a838fea06ffc413229e517e39e933020b}{pending\_request\_from}}.clear();}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \ \ \ \ \textcolor{keywordflow}{if}\ (!id\_to\_fd.count(requester\_id))\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}Requester\ disconnected.\(\backslash\)n"{}});}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00208\ \ \ \ \ \}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{keywordtype}{int}\ requester\_fd\ =\ id\_to\_fd[requester\_id];}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keywordflow}{if}\ (msg\ ==\ \textcolor{stringliteral}{"{}yes"{}})\ \{}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Clients\ connected:\ "{}}\ <<\ responder.\mbox{\hyperlink{structClientInfo_a5418fd7080628de1c1ffa5c177236bf8}{id}}\ <<\ \textcolor{stringliteral}{"{}\ <-\/>\ "{}}\ <<\ requester\_id\ <<\ std::endl;}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ responder.\mbox{\hyperlink{structClientInfo_ac1893ca9502dee20ac9f106a61c6db13}{connected\_to}}\ =\ requester\_id;}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ clients[requester\_fd].connected\_to\ =\ responder.\mbox{\hyperlink{structClientInfo_a5418fd7080628de1c1ffa5c177236bf8}{id}};}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ clients[requester\_fd].is\_speaking\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00216\ }
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ std::string\ history\ =\ \mbox{\hyperlink{history_8cpp_afc2aba136cde68f180727094b3719328}{load\_history\_for\_users}}(responder.\mbox{\hyperlink{structClientInfo_a5418fd7080628de1c1ffa5c177236bf8}{id}},\ requester\_id);}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!history.empty())\ \{}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(fd,\ \textcolor{stringliteral}{"{}Chat\ history:\(\backslash\)n"{}});}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(fd,\ history.c\_str());}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(requester\_fd,\ \textcolor{stringliteral}{"{}Chat\ history:\(\backslash\)n"{}});}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(requester\_fd,\ history.c\_str());}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(requester\_fd,\ \textcolor{stringliteral}{"{}Connection\ accepted.\ You\ are\ now\ speaking.\(\backslash\)n"{}});}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(fd,\ \textcolor{stringliteral}{"{}Connection\ established.\ You\ are\ a\ listener.\(\backslash\)n"{}});}
\DoxyCodeLine{00226\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(requester\_fd,\ \textcolor{stringliteral}{"{}Connection\ rejected.\(\backslash\)n"{}});}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}Connection\ declined.\(\backslash\)n"{}});}
\DoxyCodeLine{00229\ \ \ \ \ \}}
\DoxyCodeLine{00230\ \}}

\end{DoxyCode}
\Hypertarget{main__server_8cpp_ae66f6b31b5ad750f1fe042a706a4e3d4}\label{main__server_8cpp_ae66f6b31b5ad750f1fe042a706a4e3d4} 
\index{main\_server.cpp@{main\_server.cpp}!main@{main}}
\index{main@{main}!main\_server.cpp@{main\_server.cpp}}
\doxysubsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily int main (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Точка входа сервера. 

Запускает прослушивание порта, обрабатывает подключения и команды до получения /shutdown.

\begin{DoxyReturn}{Returns}
0 при корректном завершении, иначе код ошибки. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{main__server_8cpp_source_l00240}{240}} of file \mbox{\hyperlink{main__server_8cpp_source}{main\+\_\+server.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00241\ \ \ \ \ \mbox{\hyperlink{telegram__auth_8cpp_addc2662ff5190602846d5e93f09aa388}{ensure\_bot\_token}}();}
\DoxyCodeLine{00242\ }
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{keywordtype}{int}\ listener\ =\ socket(AF\_INET,\ SOCK\_STREAM,\ 0);}
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{keywordflow}{if}\ (listener\ ==\ -\/1)\ \{}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ perror(\textcolor{stringliteral}{"{}socket"{}});}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00247\ \ \ \ \ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordtype}{int}\ opt\ =\ 1;}
\DoxyCodeLine{00250\ \ \ \ \ setsockopt(listener,\ SOL\_SOCKET,\ SO\_REUSEADDR,\ \&opt,\ \textcolor{keyword}{sizeof}(opt));}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00252\ \ \ \ \ sockaddr\_in\ server\_addr\{\};}
\DoxyCodeLine{00253\ \ \ \ \ server\_addr.sin\_family\ =\ AF\_INET;}
\DoxyCodeLine{00254\ \ \ \ \ server\_addr.sin\_port\ =\ htons(\mbox{\hyperlink{main__server_8cpp_a765a3ccfceadb6670202a0753b6f61f1}{PORT}});}
\DoxyCodeLine{00255\ \ \ \ \ server\_addr.sin\_addr.s\_addr\ =\ INADDR\_ANY;}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00257\ \ \ \ \ \textcolor{keywordflow}{if}\ (bind(listener,\ (sockaddr*)\&server\_addr,\ \textcolor{keyword}{sizeof}(server\_addr))\ <\ 0)\ \{}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ perror(\textcolor{stringliteral}{"{}bind"{}});}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00260\ \ \ \ \ \}}
\DoxyCodeLine{00261\ }
\DoxyCodeLine{00262\ \ \ \ \ listen(listener,\ SOMAXCONN);}
\DoxyCodeLine{00263\ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Server\ listening\ on\ port\ "{}}\ <<\ \mbox{\hyperlink{main__server_8cpp_a765a3ccfceadb6670202a0753b6f61f1}{PORT}}\ <<\ std::endl;}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \ \ \ \ fd\_set\ master\_fds,\ read\_fds;}
\DoxyCodeLine{00266\ \ \ \ \ FD\_ZERO(\&master\_fds);}
\DoxyCodeLine{00267\ \ \ \ \ FD\_SET(listener,\ \&master\_fds);}
\DoxyCodeLine{00268\ \ \ \ \ FD\_SET(STDIN\_FILENO,\ \&master\_fds);}
\DoxyCodeLine{00269\ \ \ \ \ \textcolor{keywordtype}{int}\ fd\_max\ =\ listener;}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{keywordflow}{while}\ (\textcolor{keyword}{true})\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ read\_fds\ =\ master\_fds;}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (select(fd\_max\ +\ 1,\ \&read\_fds,\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr})\ ==\ -\/1)\ \{}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \ \ \ \ perror(\textcolor{stringliteral}{"{}select"{}});}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00277\ }
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ fd\ =\ 0;\ fd\ <=\ fd\_max;\ ++fd)\ \{}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!FD\_ISSET(fd,\ \&read\_fds))}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fd\ ==\ STDIN\_FILENO)\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ cmd;}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::getline(std::cin,\ cmd);}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cmd\ ==\ \textcolor{stringliteral}{"{}/shutdown"{}})\ \{}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Shutting\ down\ server...\(\backslash\)n"{}};}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\&\ [cfd,\ info]\ :\ clients)}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(cfd,\ \textcolor{stringliteral}{"{}\(\backslash\)nServer\ is\ shutting\ down.\(\backslash\)n"{}});}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\&\ [cfd,\ info]\ :\ clients)}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ close(cfd);}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ close(listener);}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Server\ stopped.\(\backslash\)n"{}};}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fd\ ==\ listener)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sockaddr\_in\ client\_addr\{\};}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ socklen\_t\ addrlen\ =\ \textcolor{keyword}{sizeof}(client\_addr);}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ client\_fd\ =\ accept(listener,\ (sockaddr*)\&client\_addr,\ \&addrlen);}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (client\_fd\ !=\ -\/1)\ \{}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}New\ client\ connected,\ fd:\ "{}}\ <<\ client\_fd\ <<\ std::endl;}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FD\_SET(client\_fd,\ \&master\_fds);}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fd\_max\ =\ std::max(fd\_max,\ client\_fd);}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ ask\_id\ =\ \textcolor{stringliteral}{"{}Enter\ your\ ID\(\backslash\)n"{}};}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(client\_fd,\ ask\_id);}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ msg;}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{socket__utils_8h_adfb7b70bdf1ffb56b41fd4b88e8b5dab}{recv\_line}}(fd,\ msg))\ \{}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{main__server_8cpp_adcd4551f3c0fc277e558c0dbe94c9084}{disconnect\_client}}(fd,\ master\_fds);}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (clients.count(fd)\ ==\ 0\ \&\&\ !pending\_auth.count(fd))\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ chat\_id\ =\ msg;}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (chat\_id.empty())\ \{}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}Chat\ ID\ cannot\ be\ empty.\ Try\ again\(\backslash\)n"{}});}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ code\ =\ \mbox{\hyperlink{telegram__auth_8cpp_a74d2f6718acaf08c27fb5c975a939cca}{generate\_auth\_code}}();}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{telegram__auth_8cpp_ad0aadb96417fb892ae3cdaf3e4b24649}{send\_telegram\_code}}(chat\_id,\ code))\ \{}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pending\_auth[fd]\ =\ chat\_id;}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ sent\ =\ \textcolor{stringliteral}{"{}Telegram\ code\ sent.\ Enter\ the\ code\ to\ log\ in\(\backslash\)n"{}};}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ sent);}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Failed\ to\ send\ Telegram\ message.\(\backslash\)nUse\ command\ /exit\ to\ "{}}}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}exit.\(\backslash\)nCheck\ the\ telegram\ ID\ and\ write\ it\ again"{}});}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00334\ }
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (pending\_auth.count(fd))\ \{}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ entered\_code\ =\ msg;}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ chat\_id\ =\ pending\_auth[fd];}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{telegram__auth_8cpp_a0bd7efd131f04d1c39a7e97276c64457}{verify\_auth\_code}}(chat\_id,\ entered\_code))\ \{}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (id\_to\_fd.count(chat\_id))\ \{}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ old\_fd\ =\ id\_to\_fd[chat\_id];}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(old\_fd,\ \textcolor{stringliteral}{"{}\(\backslash\)nYou\ have\ been\ logged\ out\ (second\ login\ detected).\(\backslash\)n"{}});}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{main__server_8cpp_adcd4551f3c0fc277e558c0dbe94c9084}{disconnect\_client}}(old\_fd,\ master\_fds);}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00344\ }
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ clients[fd]\ =\ \mbox{\hyperlink{structClientInfo}{ClientInfo}}\{fd,\ chat\_id\};}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Client\ authorized:\ "{}}\ <<\ chat\_id\ <<\ \textcolor{stringliteral}{"{}\ (fd:\ "{}}\ <<\ fd\ <<\ \textcolor{stringliteral}{"{})"{}}\ <<\ std::endl;}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ id\_to\_fd[chat\_id]\ =\ fd;}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pending\_auth.erase(fd);}
\DoxyCodeLine{00349\ }
\DoxyCodeLine{00350\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ welcome\ =}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Welcome,\ "{}}\ +\ chat\_id\ +\ \textcolor{stringliteral}{"{}!\ Use\ /connect\ <ID>,\ /vote,\ /end,\ /exit,\ /help\(\backslash\)n"{}};}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ welcome.c\_str());}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}Incorrect\ code.\ Try\ again\(\backslash\)n"{}});}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00357\ }
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!clients[fd].pending\_request\_from.empty())\ \{}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{main__server_8cpp_a9e4e4f430cdf91a029a3aaa1c1a543e6}{handle\_pending\_response}}(fd,\ msg);}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00361\ }
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!msg.empty()\ \&\&\ msg[0]\ ==\ \textcolor{charliteral}{'/'})\ \{}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{main__server_8cpp_a2162e68ba4f5ca47d17798d623fbbcb8}{handle\_client\_command}}(fd,\ msg,\ master\_fds);}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00365\ }
\DoxyCodeLine{00366\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (clients[fd].connected\_to.empty())\ \{}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}You\ are\ not\ in\ a\ conversation.\(\backslash\)nUse\ /connect\ <ID>\ to\ "{}}}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}start\ chatting.\(\backslash\)n"{}});}
\DoxyCodeLine{00371\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00373\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!clients[fd].is\_speaking)\ \{}
\DoxyCodeLine{00374\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(fd,}
\DoxyCodeLine{00375\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}You\ cannot\ send\ messages\ unless\ you're\ the\ current\ "{}}}
\DoxyCodeLine{00376\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}speaker.\(\backslash\)n"{}});}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00378\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00380\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ target\_id\ =\ clients[fd].connected\_to;}
\DoxyCodeLine{00381\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!target\_id.empty()\ \&\&\ id\_to\_fd.count(target\_id))\ \{}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ target\_fd\ =\ id\_to\_fd[target\_id];}
\DoxyCodeLine{00383\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ timestamp\ =\ \mbox{\hyperlink{main__server_8cpp_a3f3b864aa1926634aeab0d037cefc11d}{get\_timestamp}}();}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ sender\ =\ clients[fd].id;}
\DoxyCodeLine{00385\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ text\ =\ \textcolor{stringliteral}{"{}["{}}\ +\ timestamp\ +\ \textcolor{stringliteral}{"{}]\ "{}}\ +\ sender\ +\ \textcolor{stringliteral}{"{}:\ "{}}\ +\ msg\ +\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00386\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_a03a3473dbc76b30e555485f53475de14}{send\_all}}(target\_fd,\ text.c\_str());}
\DoxyCodeLine{00387\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{history_8cpp_ae34f9f425cbaa823626b71ca0129b740}{append\_message\_to\_history}}(sender,\ target\_id,\ text);}
\DoxyCodeLine{00388\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00389\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{socket__utils_8h_ab7030e8ec8c403aa4a278f6034fa4ca5}{send\_packet}}(fd,\ \textcolor{stringliteral}{"{}Not\ connected.\ Use\ /connect\ <ID>\(\backslash\)n"{}});}
\DoxyCodeLine{00390\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00391\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00392\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00393\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00394\ \ \ \ \ \}}
\DoxyCodeLine{00395\ }
\DoxyCodeLine{00396\ \ \ \ \ close(listener);}
\DoxyCodeLine{00397\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00398\ \}}

\end{DoxyCode}


\doxysubsection{Variable Documentation}
\Hypertarget{main__server_8cpp_a765a3ccfceadb6670202a0753b6f61f1}\label{main__server_8cpp_a765a3ccfceadb6670202a0753b6f61f1} 
\index{main\_server.cpp@{main\_server.cpp}!PORT@{PORT}}
\index{PORT@{PORT}!main\_server.cpp@{main\_server.cpp}}
\doxysubsubsection{\texorpdfstring{PORT}{PORT}}
{\footnotesize\ttfamily constexpr int PORT = 9090\hspace{0.3cm}{\ttfamily [constexpr]}}



Порт, на котором слушает сервер. 



Definition at line \mbox{\hyperlink{main__server_8cpp_source_l00030}{30}} of file \mbox{\hyperlink{main__server_8cpp_source}{main\+\_\+server.\+cpp}}.

