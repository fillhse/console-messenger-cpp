\doxysection{server/telegram\+\_\+auth.cpp File Reference}
\hypertarget{telegram__auth_8cpp}{}\label{telegram__auth_8cpp}\index{server/telegram\_auth.cpp@{server/telegram\_auth.cpp}}


Реализация функций Telegram-\/аутентификации\+: генерация, отправка и проверка кодов.  


{\ttfamily \#include "{}telegram\+\_\+auth.\+h"{}}\newline
{\ttfamily \#include $<$cstdio$>$}\newline
{\ttfamily \#include $<$cstdlib$>$}\newline
{\ttfamily \#include $<$ctime$>$}\newline
{\ttfamily \#include $<$filesystem$>$}\newline
{\ttfamily \#include $<$fstream$>$}\newline
{\ttfamily \#include $<$iostream$>$}\newline
{\ttfamily \#include $<$map$>$}\newline
{\ttfamily \#include $<$random$>$}\newline
{\ttfamily \#include $<$string$>$}\newline
Include dependency graph for telegram\+\_\+auth.\+cpp\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{telegram__auth_8cpp__incl}
\end{center}
\end{figure}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{telegram__auth_8cpp_a49e6447c01a81c8af7c206e1538510a0}{set\+\_\+bot\+\_\+token}} (const std\+::string \&token)
\begin{DoxyCompactList}\small\item\em Установить глобальный токен бота. \end{DoxyCompactList}\item 
std\+::string \mbox{\hyperlink{telegram__auth_8cpp_a74d2f6718acaf08c27fb5c975a939cca}{generate\+\_\+auth\+\_\+code}} ()
\begin{DoxyCompactList}\small\item\em Сгенерировать случайный шестизначный код для авторизации. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{telegram__auth_8cpp_addc2662ff5190602846d5e93f09aa388}{ensure\+\_\+bot\+\_\+token}} ()
\begin{DoxyCompactList}\small\item\em Убедиться, что токен бота загружен из файла. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{telegram__auth_8cpp_ad0aadb96417fb892ae3cdaf3e4b24649}{send\+\_\+telegram\+\_\+code}} (const std\+::string \&chat\+\_\+id, const std\+::string \&code)
\begin{DoxyCompactList}\small\item\em Отправить код авторизации через Telegram Bot API. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{telegram__auth_8cpp_a0bd7efd131f04d1c39a7e97276c64457}{verify\+\_\+auth\+\_\+code}} (const std\+::string \&chat\+\_\+id, const std\+::string \&code)
\begin{DoxyCompactList}\small\item\em Проверить введённый код авторизации. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
std\+::string \mbox{\hyperlink{telegram__auth_8cpp_ac261e08f76f7e7de9a1ace511ead28c5}{BOT\+\_\+\+TOKEN}}
\begin{DoxyCompactList}\small\item\em Глобальный токен Telegram-\/бота, используется при отправке сообщений. \end{DoxyCompactList}\item 
std\+::map$<$ std\+::string, std\+::string $>$ \mbox{\hyperlink{telegram__auth_8cpp_a5ae22537f50327cb47da0b11b774ad87}{auth\+\_\+codes}}
\begin{DoxyCompactList}\small\item\em Глобальная карта, хранящая соответствие chat\+\_\+id -\/\texorpdfstring{$>$}{>} код авторизации. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Реализация функций Telegram-\/аутентификации\+: генерация, отправка и проверка кодов. 

Использует CURL (через системный вызов curl) для отправки сообщений Telegram Bot API. Хранит временные коды в глобальной карте auth\+\_\+codes. 

Definition in file \mbox{\hyperlink{telegram__auth_8cpp_source}{telegram\+\_\+auth.\+cpp}}.



\doxysubsection{Function Documentation}
\Hypertarget{telegram__auth_8cpp_addc2662ff5190602846d5e93f09aa388}\label{telegram__auth_8cpp_addc2662ff5190602846d5e93f09aa388} 
\index{telegram\_auth.cpp@{telegram\_auth.cpp}!ensure\_bot\_token@{ensure\_bot\_token}}
\index{ensure\_bot\_token@{ensure\_bot\_token}!telegram\_auth.cpp@{telegram\_auth.cpp}}
\doxysubsubsection{\texorpdfstring{ensure\_bot\_token()}{ensure\_bot\_token()}}
{\footnotesize\ttfamily void ensure\+\_\+bot\+\_\+token (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Убедиться, что токен бота загружен из файла. 

Убедиться, что глобальный токен бота загружен.

Если переменная BOT\+\_\+\+TOKEN пуста, пытается считать токен из файла SERVER\+\_\+\+SETTINGS/\+BOT\+\_\+\+TOKEN.\+txt. При отсутствии директории или файла создаёт их. Если после чтения токен остаётся пустым — выводит сообщение об ошибке и завершает программу. 

Definition at line \mbox{\hyperlink{telegram__auth_8cpp_source_l00075}{75}} of file \mbox{\hyperlink{telegram__auth_8cpp_source}{telegram\+\_\+auth.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{telegram__auth_8cpp_ac261e08f76f7e7de9a1ace511ead28c5}{BOT\_TOKEN}}.empty())}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keyword}{namespace\ }fs\ =\ std::filesystem;}
\DoxyCodeLine{00080\ \ \ \ \ fs::path\ dir\ =\ \textcolor{stringliteral}{"{}SERVER\_SETTINGS"{}};}
\DoxyCodeLine{00081\ \ \ \ \ fs::path\ file\ =\ dir\ /\ \textcolor{stringliteral}{"{}BOT\_TOKEN.txt"{}};}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordflow}{if}\ (!fs::exists(dir))}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ fs::create\_directories(dir);}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordflow}{if}\ (fs::exists(file))\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ std::ifstream\ in(file);}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ std::getline(in,\ \mbox{\hyperlink{telegram__auth_8cpp_ac261e08f76f7e7de9a1ace511ead28c5}{BOT\_TOKEN}});}
\DoxyCodeLine{00089\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ std::ofstream\ out(file);}
\DoxyCodeLine{00091\ \ \ \ \ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{telegram__auth_8cpp_ac261e08f76f7e7de9a1ace511ead28c5}{BOT\_TOKEN}}.empty())\ \{}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ std::cerr\ <<\ \textcolor{stringliteral}{"{}[TelegramAuth]\ Файл\ "{}}\ <<\ file}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ не\ содержит\ токен.\(\backslash\)n"{}}}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Добавьте\ токен\ в\ первую\ строку\ и\ перезапустите\ сервер.\(\backslash\)n"{}};}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ exit(1);}
\DoxyCodeLine{00098\ \ \ \ \ \}}
\DoxyCodeLine{00099\ \}}

\end{DoxyCode}
\Hypertarget{telegram__auth_8cpp_a74d2f6718acaf08c27fb5c975a939cca}\label{telegram__auth_8cpp_a74d2f6718acaf08c27fb5c975a939cca} 
\index{telegram\_auth.cpp@{telegram\_auth.cpp}!generate\_auth\_code@{generate\_auth\_code}}
\index{generate\_auth\_code@{generate\_auth\_code}!telegram\_auth.cpp@{telegram\_auth.cpp}}
\doxysubsubsection{\texorpdfstring{generate\_auth\_code()}{generate\_auth\_code()}}
{\footnotesize\ttfamily std\+::string generate\+\_\+auth\+\_\+code (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Сгенерировать случайный шестизначный код для авторизации. 

Использует std\+::rand(), инициализирует генератор при первом вызове на основе текущего времени.

\begin{DoxyReturn}{Returns}
Сгенерированный код (строка из 6 цифр). 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{telegram__auth_8cpp_source_l00052}{52}} of file \mbox{\hyperlink{telegram__auth_8cpp_source}{telegram\+\_\+auth.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ seeded\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordflow}{if}\ (!seeded)\ \{}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ std::srand(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{unsigned}\textcolor{keyword}{>}(std::time(\textcolor{keyword}{nullptr})));}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ seeded\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00057\ \ \ \ \ \}}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \ \ std::string\ digits\ =\ \textcolor{stringliteral}{"{}0123456789"{}},\ code;}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 6;\ ++i)}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ code\ +=\ digits[std::rand()\ \%\ 10];}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordflow}{return}\ code;}
\DoxyCodeLine{00063\ \}}

\end{DoxyCode}
\Hypertarget{telegram__auth_8cpp_ad0aadb96417fb892ae3cdaf3e4b24649}\label{telegram__auth_8cpp_ad0aadb96417fb892ae3cdaf3e4b24649} 
\index{telegram\_auth.cpp@{telegram\_auth.cpp}!send\_telegram\_code@{send\_telegram\_code}}
\index{send\_telegram\_code@{send\_telegram\_code}!telegram\_auth.cpp@{telegram\_auth.cpp}}
\doxysubsubsection{\texorpdfstring{send\_telegram\_code()}{send\_telegram\_code()}}
{\footnotesize\ttfamily bool send\+\_\+telegram\+\_\+code (\begin{DoxyParamCaption}\item[{const std\+::string \&}]{chat\+\_\+id,  }\item[{const std\+::string \&}]{code }\end{DoxyParamCaption})}



Отправить код авторизации через Telegram Bot API. 

Формирует HTTP запрос с помощью системного вызова curl и отправляет код пользователю в чат.


\begin{DoxyParams}{Parameters}
{\em chat\+\_\+id} & Идентификатор Telegram-\/чата. \\
\hline
{\em code} & Шестизначный код авторизации. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
true если запрос выполнен успешно (ответ содержит "{}ok"{}\+:true), и код сохранён в auth\+\_\+codes; иначе false. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{telegram__auth_8cpp_source_l00114}{114}} of file \mbox{\hyperlink{telegram__auth_8cpp_source}{telegram\+\_\+auth.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00115\ \ \ \ \ \mbox{\hyperlink{telegram__auth_8cpp_addc2662ff5190602846d5e93f09aa388}{ensure\_bot\_token}}();}
\DoxyCodeLine{00116\ \ \ \ \ std::string\ url\ =\ \textcolor{stringliteral}{"{}https://api.telegram.org/bot"{}}\ +\ \mbox{\hyperlink{telegram__auth_8cpp_ac261e08f76f7e7de9a1ace511ead28c5}{BOT\_TOKEN}}\ +\ \textcolor{stringliteral}{"{}/sendMessage"{}};}
\DoxyCodeLine{00117\ \ \ \ \ std::string\ cmd\ =\ \textcolor{stringliteral}{"{}curl\ -\/s\ -\/X\ POST\ \(\backslash\)"{}"{}}\ +\ url\ +}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}\(\backslash\)"{}"{}}}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}\ -\/d\ chat\_id="{}}\ +}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ chat\_id\ +\ \textcolor{stringliteral}{"{}\ -\/d\ text='Your\ authentication\ code\ is:\ "{}}\ +\ code\ +\ \textcolor{stringliteral}{"{}'"{}};}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \ \ FILE*\ pipe\ =\ popen(cmd.c\_str(),\ \textcolor{stringliteral}{"{}r"{}});}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{keywordflow}{if}\ (!pipe)}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ \ \ std::string\ response;}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordtype}{char}\ buf[256];}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordflow}{while}\ (fgets(buf,\ \textcolor{keyword}{sizeof}(buf),\ pipe))}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ response\ +=\ buf;}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keywordtype}{int}\ status\ =\ pclose(pipe);}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{keywordflow}{if}\ (status\ ==\ 0\ \&\&\ response.find(\textcolor{stringliteral}{"{}\(\backslash\)"{}ok\(\backslash\)"{}:true"{}})\ !=\ std::string::npos)\ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{telegram__auth_8cpp_a5ae22537f50327cb47da0b11b774ad87}{auth\_codes}}[chat\_id]\ =\ code;}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00135\ \ \ \ \ \}}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00137\ \}}

\end{DoxyCode}
\Hypertarget{telegram__auth_8cpp_a49e6447c01a81c8af7c206e1538510a0}\label{telegram__auth_8cpp_a49e6447c01a81c8af7c206e1538510a0} 
\index{telegram\_auth.cpp@{telegram\_auth.cpp}!set\_bot\_token@{set\_bot\_token}}
\index{set\_bot\_token@{set\_bot\_token}!telegram\_auth.cpp@{telegram\_auth.cpp}}
\doxysubsubsection{\texorpdfstring{set\_bot\_token()}{set\_bot\_token()}}
{\footnotesize\ttfamily void set\+\_\+bot\+\_\+token (\begin{DoxyParamCaption}\item[{const std\+::string \&}]{token }\end{DoxyParamCaption})}



Установить глобальный токен бота. 

Установить глобальный токен Telegram-\/бота.

Сохраняет переданный токен в переменную BOT\+\_\+\+TOKEN.


\begin{DoxyParams}{Parameters}
{\em token} & Токен бота, выданный Bot\+Father. \\
\hline
\end{DoxyParams}


Definition at line \mbox{\hyperlink{telegram__auth_8cpp_source_l00033}{33}} of file \mbox{\hyperlink{telegram__auth_8cpp_source}{telegram\+\_\+auth.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00034\ \ \ \ \ \mbox{\hyperlink{telegram__auth_8cpp_ac261e08f76f7e7de9a1ace511ead28c5}{BOT\_TOKEN}}\ =\ token;}
\DoxyCodeLine{00035\ \}}

\end{DoxyCode}
\Hypertarget{telegram__auth_8cpp_a0bd7efd131f04d1c39a7e97276c64457}\label{telegram__auth_8cpp_a0bd7efd131f04d1c39a7e97276c64457} 
\index{telegram\_auth.cpp@{telegram\_auth.cpp}!verify\_auth\_code@{verify\_auth\_code}}
\index{verify\_auth\_code@{verify\_auth\_code}!telegram\_auth.cpp@{telegram\_auth.cpp}}
\doxysubsubsection{\texorpdfstring{verify\_auth\_code()}{verify\_auth\_code()}}
{\footnotesize\ttfamily bool verify\+\_\+auth\+\_\+code (\begin{DoxyParamCaption}\item[{const std\+::string \&}]{chat\+\_\+id,  }\item[{const std\+::string \&}]{code }\end{DoxyParamCaption})}



Проверить введённый код авторизации. 

Проверить введённый пользователем код авторизации.

Сравнивает переданный {\ttfamily code} с сохранённым в auth\+\_\+codes для данного {\ttfamily chat\+\_\+id}.


\begin{DoxyParams}{Parameters}
{\em chat\+\_\+id} & Идентификатор Telegram-\/чата. \\
\hline
{\em code} & Введённый пользователем код. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
true если код корректен и сохранённая запись совпадает; иначе false. 
\end{DoxyReturn}


Definition at line \mbox{\hyperlink{telegram__auth_8cpp_source_l00150}{150}} of file \mbox{\hyperlink{telegram__auth_8cpp_source}{telegram\+\_\+auth.\+cpp}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{telegram__auth_8cpp_a5ae22537f50327cb47da0b11b774ad87}{auth\_codes}}.count(chat\_id)\ \&\&\ \mbox{\hyperlink{telegram__auth_8cpp_a5ae22537f50327cb47da0b11b774ad87}{auth\_codes}}[chat\_id]\ ==\ code;}
\DoxyCodeLine{00152\ \}}

\end{DoxyCode}


\doxysubsection{Variable Documentation}
\Hypertarget{telegram__auth_8cpp_a5ae22537f50327cb47da0b11b774ad87}\label{telegram__auth_8cpp_a5ae22537f50327cb47da0b11b774ad87} 
\index{telegram\_auth.cpp@{telegram\_auth.cpp}!auth\_codes@{auth\_codes}}
\index{auth\_codes@{auth\_codes}!telegram\_auth.cpp@{telegram\_auth.cpp}}
\doxysubsubsection{\texorpdfstring{auth\_codes}{auth\_codes}}
{\footnotesize\ttfamily std\+::map$<$std\+::string, std\+::string$>$ auth\+\_\+codes}



Глобальная карта, хранящая соответствие chat\+\_\+id -\/\texorpdfstring{$>$}{>} код авторизации. 



Definition at line \mbox{\hyperlink{telegram__auth_8cpp_source_l00040}{40}} of file \mbox{\hyperlink{telegram__auth_8cpp_source}{telegram\+\_\+auth.\+cpp}}.

\Hypertarget{telegram__auth_8cpp_ac261e08f76f7e7de9a1ace511ead28c5}\label{telegram__auth_8cpp_ac261e08f76f7e7de9a1ace511ead28c5} 
\index{telegram\_auth.cpp@{telegram\_auth.cpp}!BOT\_TOKEN@{BOT\_TOKEN}}
\index{BOT\_TOKEN@{BOT\_TOKEN}!telegram\_auth.cpp@{telegram\_auth.cpp}}
\doxysubsubsection{\texorpdfstring{BOT\_TOKEN}{BOT\_TOKEN}}
{\footnotesize\ttfamily std\+::string BOT\+\_\+\+TOKEN}



Глобальный токен Telegram-\/бота, используется при отправке сообщений. 

Должен быть установлен до вызова \doxylink{telegram__auth_8h_ad0aadb96417fb892ae3cdaf3e4b24649}{send\+\_\+telegram\+\_\+code()}. 

Definition at line \mbox{\hyperlink{telegram__auth_8cpp_source_l00022}{22}} of file \mbox{\hyperlink{telegram__auth_8cpp_source}{telegram\+\_\+auth.\+cpp}}.

